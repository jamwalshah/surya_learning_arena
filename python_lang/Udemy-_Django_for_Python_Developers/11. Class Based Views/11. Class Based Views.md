# 11. Class Based Views

## 107. CBV in Action

- In this lecture, you'll create your very first `Class-Based-View`
- To do that, goto the terminal/command-line, under the projects directory `djangoprojects`, create a new project `classBasedViews` using command below

  ```bash
  django-admin startproject classBasedViews
  ```

- Change directory into project directory `classBasedViews`

  ```bash
  cd classBasedViews
  ```

- Create a Django App `cbvApp` in this project

  ```bash
  python manage.py startapp cbvApp
  ```

- Goto the project directory `djangoprojects\classBasedViews` and open it in your IDE
- Open `views.py` file, Creating a Class-Based-View is very easy, so create a class `GreetingView()` which should extend `View` from `django.views.generic`
  - And within this class `GreetingView()`, we're going to define separate methods for each HTTP method we're going to support, for now just add `get(self, request)`, so when a HTTP `GET` method is invoked this method will get the request and also has access to self, within this method we'll return the `HttpResponse()` just like we've done earlier by importing `HttpResponse` from `django.http`, and pass in the string that you want

    ```python
    from django.shortcuts import render
    from django.views.generic import View
    from django.http import HttpResponse

    # Create your views here.
    class GreetingView(View):
        def get(self, request):
            return HttpResponse("<b>First CBV says hello !!</b>")
    ```

- Goto `urls.py` file which is under the project itself, configure a new `path()` setting the route as root directory `/` by specifying an empty string, and view as a call to `as_view()` method in `views.GreetingView` which is expected to be callable object/method so that this additional step of `as_view()` will invoke a function call to return an HTTP Response.
  - So when a GET request is received on this URL path, it creates an instance of views class `GreetingView`, the request goes to the `get()` method of this class which will return a `HttpResponse` with some content that will be rendered to the template.

    ```python
    from django.contrib import admin
    from django.urls import path
    from cbvApp import views

    urlpatterns = [
        path('admin/', admin.site.urls),
        path('', views.GreetingView.as_view()),
    ]
    ```

- Goto `settings.py` file
  - goto `INSTALLED_APPS` property and append the App `cbvApp` here

    ```python
    INSTALLED_APPS = [
        'django.contrib.admin',
        'django.contrib.auth',
        'django.contrib.contenttypes',
        'django.contrib.sessions',
        'django.contrib.messages',
        'django.contrib.staticfiles',
        'cbvApp'
    ]
    ```

- Goto the terminal/command-line, start the Django server using command below

  ```bash
  python manage.py runserver
  ```

- Open the web-browser and visit the URL at `localhost:8000`, and it should display a message `First CBV says hello !!`
- In this lecture, we've successfully created a Class-Based-View
  - We've created a project, then an Application
  - Within `views.py` we've created a class `GreetingView` which inherits from `django.views.generic.View` and inside this class we need to override the HTTP methods, one method for each HTTP method, if you want to support the `GET` request then implement the `get()` method, and if you want support the `POST` request then implement the `post()` method and so on.
  - This `get()` method takes a request and we need to return an `HttpResponse`
  - In `urls.py` the `path()` method expects a callable object/method, we can't use only the view class name, so we use `views.GreetingView.as_view()`
  - When a request comes in, internally this `as_view()` method will resolve to the view class `GreetingView` and is responsible for figuring which method (GET/POST/etc.) is coming in the incoming request and will call the appropriate method on this class, if is `GET` request, it'll call `get()` method or if it is `POST` request, it'll call the `post()` method and so on

## 108. Setting Attributes on a CBV

- All the code in Class-Based-Views will go into the the methods that we define in the view class
- But we can also define attribute in this class, although not required, we can define attributes in the class and set/assign values to those attributes from within the `as_view()` function at runtime
- Goto `views.py` file, and we'll customize the message content that is displayed from the `get()` function instead of hardcoding it like earlier, by passing a message right from `as_view()` function call from the `path()` in `urls.py`, modify the `views.py` as per code below

  ```python
  from django.shortcuts import render
  from django.views.generic import View
  from django.http import HttpResponse

  # Create your views here.
  class GreetingView(View):
      greetingMessage = '<b>First CBV says hello !!</b>'
      def get(self, request):
          return HttpResponse(content=self.greetingMessage)
  ```

- Now we can override this `greetingMessage` from within the `as_view()` in `urls.py` as below

  ```python
  from django.contrib import admin
  from django.urls import path
  from cbvApp import views

  urlpatterns = [
      path('admin/', admin.site.urls),
      path(route='', view=views.GreetingView.as_view(greetingMessage = '<h1>Hello from the as_view method</h1>')),
  ]
  ```

- This is how we can pass the data or set the attributes on a particular view from the `urls.py` file, because when the Django server request comes in, `as_view()` method will create an instance of the view class `GreetingView` and it is also responsible for setting the values for all the attribute in that class, internally it'll use other methods to do that, so we can pass to it whichever attribute we want
- Django server should've reloaded everything for us, goto the web-browser and refresh the URL at `localhost:8000` and you'll see a different message that says `Hello from the as_view method`
- Initially `First CBV says hello !!` will be the message it'll hold, but when the request comes in it'll set `Hello from the as_view method` as the value

## 109. Hands on Steps

- In the next few lectures, you'll be performing CRUD operations on the same `Student` model/database table that you've created earlier, but this time using Class-Based-Views, it's going to be much more easier than compared to Function-Based-Views to perform the CRUD operations
- You'll display the details of a student, you'll allow user to add a student where he can fill in the form just like before, and he can click on a student on a link in `Id` column, and then we'll be able to see the student details, if he wants to delete the student he can or he can update the student's test score
- We can allow what fields he can update which we'll configure, and if we click on delete, there will be a confirmation as well, and if you click cancel then it'll go back to the Student Details page
- All that will come for us when we use Class-Based-Views

## 110. Create Project

- In this lecture, we'll create a Class-Based-View project to perform the CRUD operations
- To do that, goto terminal/command-line, make sure you're under the project directory `djangoprojects`, create a new project `cbvCRUD` using command below, which uses Class-Based-Views using generics

  ```bash
  django-admin startproject cbvCRUD
  ```

- Go into the project directory `djangoprojects\cbvCRUD`

  ```bash
  cd cbvCRUD
  ```

- Create an app `cbvApp` using command below

  ```bash
  python manage.py startapp cbvApp
  ```

- Goto that project folder `djangoprojects\cbvCRUD`, and open it in your IDE
- Open the `settings.py` file, search for `INSTALLED_APPS` property, append the app `cbvApp` to this list as below

  ```python
  INSTALLED_APPS = [
      'django.contrib.admin',
      'django.contrib.auth',
      'django.contrib.contenttypes',
      'django.contrib.sessions',
      'django.contrib.messages',
      'django.contrib.staticfiles',
      'cbvApp'
  ]
  ```

- The next setting is the database setting, in `settings.py` file, search for `DATABASES` property, and update it as below which is same as you've done in `fbvCRUD` project

  ```python
  DATABASES = {
      'default': {
          'ENGINE': 'django.db.backends.mysql',
          'NAME': 'studentdb',
          'USER': 'root',
          'PASSWORD': 'mysql',
      }
  }
  ```

- We don't need to configure the template here, because the this time templates will eb automatically resolved for us, we don't have to configure a specific template directory, thanks to generics
- Next we will create the models, using the same model as we used in `fbvCRUD` project, we'll create here also, open the `models.py` file and create the model as below

  ```python
  from django.db import models

  # Create your models here.
  class Student(models.Model):
      """Model definition for Student."""
      firstName = models.CharField(max_length=20)
      lastName = models.CharField(max_length=20)
      testScore = models.FloatField()
  ```

- In this lecture, we've successfully created a project, and also a model
- In the next lecture, you'll see how easy it is to use generics and perform CRUD operations, one operation at a time

## 111. Create List View

- In this lecture, we'll learn how to create views using generics
- Goto `views.py` file, since we're going to use generics, so import `ListView` for now from `django.views.generic`
- next crate a class `StudentListView(ListView)` which will extend the `ListView`, and in this class, all we need to provide is model class, but after importing `student` model from `cbvCRUD.models`, so it'll fetch all the data for the students which will be sent to a default `template_name` parameter is a template named in format `modelname_list.html` resulting into template file `student_list.html`, so we'll require to create a template with this name and the `context_object_name` parameter is available in the format `modelname_list` resulting into context variable `student_list`, we can loop through this context variable and play around it
- If you want to override the `template_name`, you may specify it using the class attribute `template_name` inside the view class `StudentListView`

  ```python
  from django.shortcuts import render
  from django.views.generic import ListView
  from cbvApp.models import Student

  # Create your views here.
  class StudentListView(ListView):
      """ListView definition for view to list data from Student Model"""
      model = Student
      # template_name = 'student_list.html'
      # default template_name is student_list.html
      # context_object_name = 'student_list'
      # default context_object_name is student_list
  ```

- In the next lecture, we'll be creating a template `student_list.html` and we'll be using the context variable `student_list` to display the student data
- In this lecture, you've created your very first generic view by extending the `ListView` and simply providing it the Model class name `Student`

## 112. Create List Template

- In this lecture, we'll create the `student_list.html` template
- To do that, we'll have to create a folder under our `cbvApp`, so that by default Django generics will search for this template under `cbvApp/templates/cbvApp`, and in this folder create a template file named `student_list.html`
- In `student_list.html`, you may put the HTML from the `index.html` from `fbvCRUD` project, and then modify it as below code by changing the context variable to `student_list`
- The links to `Add Student`, `Delete` and `Update` will be moved later on, but for now leave them there, and `Delete` & `Update` links will be moved to student Details page which you'll be creating later on

  ```html
  <!DOCTYPE html>
  <html lang="en" dir="ltr">
      <head>
          <meta charset="utf-8">
          <title>Student Information</title>
      </head>
      <body>
          <h1>Students</h1>
          <table border=2>
              <thead>
                  <th>Id</th>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Test Score</th>
              </thead>
              {% for student in student_list %}
                  <tr>
                      <td>{{ student.id }}</td>
                      <td>{{ student.firstName }}</td>
                      <td>{{ student.lastName }}</td>
                      <td>{{ student.testScore }}</td>
                      <td><a href="/delete/{{ student.id }}">Delete</a></td>
                      <td><a href="/update/{{ student.id }}">Update</a></td>
                  </tr>
              {% endfor %}
          </table>
          <br/><br/><br/>
          <a href="/create">Add Student</a>
      </body>
  </html>
  ```

## 113. Test List View

- In this lecture, we'll configure the URLs, do the migrations and test our application
- Goto `urls.py`, add a `path()` with route as `students/` and views as `StudentListView.as_view()`

  ```python
  from django.contrib import admin
  from django.urls import path
  from cbvApp import views

  urlpatterns = [
      path('admin/', admin.site.urls),
      path('students/', views.StudentListView),
  ]
  ```

- Goto the terminal/command-line, make sure that you're under the project directory `djangoprojects\cbvCRUD`, and do the migrations, Although the database is same, but we're using a different app, so it'll generate a different table

  ```bash
  python manage.py makemigrations
  ```

  ```bash
  python manage.py migrate
  ```

- Now all the migrations are in, now if you goto the MySQL Workbench, and list all the tables using command below, along with previous table `fbvapp_student`, we now have `cbvapp_student`

  ```sql
  USE studentdb;
  SHOW TABLES;
  ```

- First list all records from table `cbvapp_student`, and it show not list any records as it is an empty table

  ```sql
  SELECT * FROM cbvapp_student;
  ```

- Lets insert a record into the `cbvapp_student` table, and we'll have one record in the table

  ```sql
  INSERT INTO cbvapp_student VALUES (1, 'John', 'Feguson', 90);
  ```

- Start the Django server for this project using command below

  ```bash
  python manage.py runserver
  ```

- Now, goto the web-browser, and visit the URL at `localhost:8000`, and you'll get an error message `Page not found (404)` indicating that the URL patterns are `admin/` and `students/`
- Now open the URL at `localhost:8000/students`, and you'll see the records from the database in a table format
- So, with the very minimal work of simply implementing a view, once we have a `Model` class, we implement a `ListView` class by extending it, provide a model to it, and it'll take care of fetching the data for us and sending it to a template which we've created in the folder `cbvApp/template/cbvApp` which is being rendered beautifully

## 114. Implement Student Details

- In this lecture, you'll learn how to use the `DetailView` from the `django.views.generic`
- We'll provide a link on the `Id` column, when that link is clicked, it should display all the Student details on a separate page from which you can `Update` and `Delete` later on
- Goto `views.py` file, and define a new view class `StudentDetailView(DetailView)` which will extend `DetailView` from `django.views.generic`
, and all we need to do is to provide Model information
  - The default context parameter name and template name are different here
  - The default `template_name` will be in format `modelname_detail.html`, resulting into `student_detail.html`
  - The default `context_object_name` will be in format `modelname`, resulting into `student`
  - So you can access the `student` context parameter in the template `student_detail.html`

    ```python
    class StudentDetailView(DetailView):
        """DetailView definition for view to display detail data from Student Model"""
        model = Student
        # template_name = 'student_list.html'
        # default template_name is student_list.html
        # context_object_name = 'student_list'
        # default context_object_name is student_list
    ```

- Now Create a template file `cbvApp/templates/cbvApp/student_detail.html`, open it and add the html code below to it

  ```html
  <!DOCTYPE html>
  <html lang="en" dir="ltr">
      <head>
          <meta charset="utf-8">
          <title>Student Details</title>
      </head>
      <body>
          <h1>Student Details</h1>
          <ol>
              <h3><li>First Name: {{ student.firstName }}</li></h3>
              <h3><li>Last Name: {{ student.lastName }}</li></h3>
              <h3><li>Test Score: {{ student.testScore }}</li></h3>
          </ol>
      </body>
  </html>
  ```

- So, you've successfully implemented the view and the template
- Goto `urls.py` file, add a `path()` as shown below

  ```python
  from django.contrib import admin
  from django.urls import path
  from cbvApp import views

  urlpatterns = [
      path('admin/', admin.site.urls),
      path('students/', views.StudentListView.as_view()),
      path('<int:pk>/', views.StudentDetailView.as_view()),
  ]
  ```

- Now we have to add the route URL to the link in the `student_list.html` template on the `Id` column
- Goto the `student_list.html` file, and add the link `/{{ student.id }}` to the `Id` column as below, which is the URL we have mapped in the route, all it expects is the primary key `pk`, which should goto the `DetailView`

  ```html
  <!DOCTYPE html>
  <html lang="en" dir="ltr">
      <head>
          <meta charset="utf-8">
          <title>Student Information</title>
      </head>
      <body>
          <h1>Students</h1>
          <table border=2>
              <thead>
                  <th>Id</th>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Test Score</th>
              </thead>
              {% for student in student_list %}
                  <tr>
                      <td><a href="/{{ student.id }}">{{ student.id }}</a></td>
                      <td>{{ student.firstName }}</td>
                      <td>{{ student.lastName }}</td>
                      <td>{{ student.testScore }}</td>
                      <td><a href="/delete/{{ student.id }}">Delete</a></td>
                      <td><a href="/update/{{ student.id }}">Update</a></td>
                  </tr>
              {% endfor %}
          </table>
          <br/><br/><br/>
          <a href="/create">Add Student</a>
      </body>
  </html>
  ```

- Now goto the web-browser and refresh/visit the URL at `localhost:8000/students`, and it'll load the `Id` column with a link
  - Click on the Id column value `1`, and it'll open the `DetailsView` template page, which displays all the student details `First Name`, `Last Name` and `Test Score`
- To summarize the steps
  - To use the `DetailView`, we start by creating a new class `StudentDetailView` that extends the `DetailView`, you tell it the Model class `Student` that this DetailView class is responsible for rendering, it'll fetch the data and put the data into an object `student` using the Model name in lower-case, it'll send the data by default to `student_detail.html` template, so that Django template loader will look for the template under `ProjectName/AppName/templates/AppName/student_detail.html`, which is where we're rendering our data, and the link for it is the primary key `pk` of that particular `student` model object, once the URL is mapped, you can use that in the list page `student_list.html` on the `Id` column, so that when that is clicked, that student's details will be rendered

## 115. Create

- So far, we've successfully performed the `Read` operations, that is reading all the students, displaying them, and also the student details
- In this and the next lecture, you'll work on the `Create` operation
- To do that, goto `views.py` file
  - First import `CreateView` from the `django.views.generic`
  - Create a new class `StudentCreateView(CreateView)` which will extend the `CreateView`
    - Within this class define the Model and there is also an additional attribute called `fields`, without which you'll get an error at runtime
    - in this `fields` attribute, we need to tell which fields we need to insert during the insertion or creation process
    - we have four different fields in this table, but `id` field we need not give it, so assign a tuple of fields `firstName`, `lastName`, `testScore` to `fields` attribute
    - You can also ignore some fields if you don't want to provide values for them
    - The default template_name will be in format `modelname_form.html`, resulting into `student_form.html`

      ```python
      class StudentCreateView(CreateView):
          """CreateView definition for view to create student from Student Model"""
          model = Student
          fields = ('firstName', 'lastName', 'testScore')
          # template_name = 'student_form.html'
          # default template_name is student_form.html
          # context_object_name = 'form'
          # default context_object_name is form
      ```

- Now create a template file `cbvApp/templates/cbvApp/student_form.html`, and add the code below

  ```html
  <!DOCTYPE html>
  <html lang="en" dir="ltr">
      <head>
          <meta charset="utf-8">
          <title>Create Student</title>
      </head>
      <body>
          <h1>Create Student</h1>
          <form method="post">
              {{ form.as_p }}
              {% csrf_token %}
              <input type="submit" value="Save">
          </form>
      </body>
  </html>
  ```

- In this lecture
  - you've created a Student View, added a new attribute called `fields` which is required for Update as well
  - then you've created a template with name in format `ModelName_form.html` resulting into `student_from.html` under your templates folder, and within that you've added a form that will eb rendered to you
- There is an additional step which we need to do in the Model class for Create to work, we need to mention where it should go after the create operation
  - we can do that in Create View class by providing a result URL or we can do that in the Model class by overriding a method, out of which overriding the method is th preferred way and will be shown later

## 116. Test Create

- In this lecture, we'll tell Django where it should go after `StudentCreateView` is created and will configure the URL and test our application
- To do that, goto `models.py`, adn we need to create a function `get_absolute_url(self)` inside class `Student(models.Model)` within which a view needs to be returned that will be used when the creation process is completed, and this function will be invoked by Django automatically
- In the `get_absolute_url()` function in `models.py`, `reverse()` expects a primary key as indicated in the URL path for view with name `detail` and second parameter it expects is the primary which we pass using the `pk` in the model itself, referenced using `self.pk`

  ```python
  from django.db import models
  from django.urls import reverse
  # Create your models here.
  class Student(models.Model):
      """Model definition for Student."""
      firstName = models.CharField(max_length=20)
      lastName = models.CharField(max_length=20)
      testScore = models.FloatField()
      
      def get_absolute_url(self):
          return reverse('detail', kwargs={'pk': self.pk})
  ```

- And we'll need the URL path name in the `reverse()` function for the view to which we want it to go after creation process, open `urls.py` file and modify it as below to add a path `name` parameter to the URL path for `views.StudentDetailView`

  ```python
  urlpatterns = [
      path('admin/', admin.site.urls),
      path('students/', views.StudentListView.as_view()),
      path('<int:pk>/', views.StudentDetailView.as_view(), name='detail'),
  ]
  ```

- Now goto `urls.py` file, and create a new URL path for this `StudentCreateView` as indicated below

  ```python
  urlpatterns = [
      path('admin/', admin.site.urls),
      path('students/', views.StudentListView.as_view()),
      path('<int:pk>/', views.StudentDetailView.as_view(), name='detail'),
      path('create/', views.StudentCreateView.as_view())
  ]
  ```

- Goto your command line, Django server is already running, make sure there are no errors
- Now open web-browser and open the URL at `localhost:8000/students`, and click on `Add Student` link, and a form will be rendered, Enter FirstName, LastName and TestScore, and click on `Save`, and it'll load the `StudentDetailView` to show the details of the student
- So it creates a record in the database, and then goes to the Student Details Page
- You can check the database if you want to, open the MySQL Workbench, and run the SELECt query below to see all the data

  ```sql
  SELECT * FROM cbvapp_student;
  ```

- To reiterate, in the `models.py`, you've created a method called `get_absolute_url(self)`, within that you're using a `reverse('detail', kwargs={'pk': self.pk})` method that takes a view name and it knows how to render that view using the parameters that we're passing which is Primary Key, and after that you've configure the URL, and that URL is linked in the `student_list.html` page which is the first page, and then we've seen it working in the UI

## 117. Update

- Now that you've created the create operation successfully, the Update operation will be super-simple, because we already have a form which can be reused
- Goto `views.py`, import the `UpdateView`from `django.views.generic`, anc create a class `StudentUpdateView` extending from `UpdateView`, and it'll take the model and specify the required field `testScore`

  ```python
  class StudentUpdateView(UpdateView):
      """UpdateView definition for view to update testScore from Student Model"""
      model = Student
      fields = ('testScore', )
      # template_name = "student_form.html"
      # context_object_name = 'form'
  ```

- Goto `urls.py`, add a path as below

  ```python
  urlpatterns = [
      path('admin/', admin.site.urls),
      path('students/', views.StudentListView.as_view()),
      path('<int:pk>/', views.StudentDetailView.as_view(), name='detail'),
      path('create/', views.StudentCreateView.as_view()),
      path('update/<int:pk>/', views.StudentUpdateView.as_view()),
  ]
  ```

- The last step is to add the links, for that, delete the `update/` and `delete/` links within `<td>` in `student_list.html`

  ```html
  <!DOCTYPE html>
  <html lang="en" dir="ltr">
      <head>
          <meta charset="utf-8">
          <title>Student Information</title>
      </head>
      <body>
          <h1>Students</h1>
          <table border=2>
              <thead>
                  <th>Id</th>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Test Score</th>
              </thead>
              {% for student in student_list %}
                  <tr>
                      <td><a href="/{{ student.id }}">{{ student.id }}</a></td>
                      <td>{{ student.firstName }}</td>
                      <td>{{ student.lastName }}</td>
                      <td>{{ student.testScore }}</td>
                  </tr>
              {% endfor %}
          </table>
          <br/><br/><br/>
          <a href="/create">Add Student</a>
      </body>
  </html>
  ```

- and paste those links in `student_detail.html`, but within `<h3>`

  ```html
  <!DOCTYPE html>
  <html lang="en" dir="ltr">
      <head>
          <meta charset="utf-8">
          <title>Student Details</title>
      </head>
      <body>
          <h1>Student Details</h1>
          <ol>
              <h3><li>First Name: {{ student.firstName }}</li></h3>
              <h3><li>Last Name: {{ student.lastName }}</li></h3>
              <h3><li>Test Score: {{ student.testScore }}</li></h3>
              <h3><li><a href="/delete/{{ student.id }}">Delete</a></li></h3>
              <h3><li><a href="/update/{{ student.id }}">Update</a></li></h3>
          </ol>
      </body>
  </html>
  ```

- Goto the web-browser and visit the URL at `localhost:8000/students/`, the students list will be loaded, now goto the details page of any of the students and you'll see the `Update` and `Delete` links, delete is not implemented yet
  - Click on `Update` link, and you'll see a form to update the `TestScore`
  - It'll lead the same form `student_form.html` but we're restricting the fields from the view `StudentUpdateView` to display only `testScore` field
  - Enter new value for Test Score and hit `Save`, it saves that score and goes back to the details page

## 118. Delete

- In this lecture, we'll perform the last of the CRUD operations which is the Delete operation
- To do that, the first step is to create the View, goto the `views.py`, import the `DeleteView` from `django.views.generic`, create a new view class `StudentDeleteView` extending from `DeleteView`, and it'll take the `model` and a `success_url`
  - Earlier in case of Create and Update, the `success_url` was provided through `get_absolute_url(self)` method in the model class indicating where Django should send the user next view, and the next view is available through this method `get_absolute_url(self)`
  - But Now we don't want to use this details page as rendered by `get_absolute_url(self)` method because we're deleting the record and there will be no details left for the student after deletion
  - We can use this attribute `success_url` in other views as well and it is the recommended approach
  - So we'll provide this URL using `reverse_lazy`, so import `reverse_lazy` from `django.urls`, but using `reverse` will lead to exceptions due to circular dependency
  - `reverse_lazy()` will take a URL path name for view only and will return a success URL to which Django redirects after deletion operation
    - First we'll give a name `students` to the URL path for `StudentListView` in the `urls.py` file

      ```python
      urlpatterns = [
          path('admin/', admin.site.urls),
          path('students/', views.StudentListView.as_view(), name='students'),
          path('<int:pk>/', views.StudentDetailView.as_view(), name='detail'),
          path('create/', views.StudentCreateView.as_view()),
          path('update/<int:pk>/', views.StudentUpdateView.as_view()),
      ]
      ```

    - Then add the `success_url` attribute using `reverse_lazy()` method as below in `views.py`

      ```python
      class StudentDeleteView(DeleteView):
          """DeleteView definition for view to delete from Student Model"""
          model = Student
          success_url = reverse_lazy('students')
          # template_name = "student_confirm_delete.html"
          # context_object_name = 'student'
      ```

- Now we'll add a confirmation template to ask the end user for confirmation before deleting, so create a file `cbvApp/templates/cbvApp/student_confirm_delete.html` and modify it as below

  ```html
  <!DOCTYPE html>
  <html lang="en" dir="ltr">
      <head>
          <meta charset="utf-8">
          <title>Delete Student</title>
      </head>
      <body>
          <h2>Delete Student {{ student.firstName }} ?</h2>
          <form method="post">
              <input type="submit" value="Confirm">
              <a href="/{{ student.id }}">Cancel</a>
              {% csrf_token %}
          </form>
      </body>
  </html>
  ```

- Now open `urls.py` and add a new URL Path as below

  ```python
  urlpatterns = [
      path('admin/', admin.site.urls),
      path('students/', views.StudentListView.as_view(), name='students'),
      path('<int:pk>/', views.StudentDetailView.as_view(), name='detail'),
      path('create/', views.StudentCreateView.as_view()),
      path('update/<int:pk>/', views.StudentUpdateView.as_view()),
      path('delete/<int:pk>/', views.StudentDeleteView.as_view()),
  ]
  ```

- Open the web-browser and visit the URL at `localhost:8000/students/`, and it lists out all the students, click on the `id` of any of the students, it opens the details page for that student, click on the `Delete` link and you'll see a delete confirmation page, if you click `Confirm` it'll delete that student and goes back to student list page, or if you click on `Cancel` it'll go back to the student details page

## Assignment 7 : CBV CRUD

- As an assignment for cbvCRUD, instructor wants you to use the same Course Model which you've earlier in the fbvCRUD assignment

  ```text
  Course
    name
    description
    instructor
    rating
  ```

- And perform CRUD operations but using Class-Based Views
- Remember to create a new project, a new app, migrate against this `Course` Model, it'll create a new table

### Solution

#### Create the Project

- First goto the project directory `djangoprojects`, launch terminal/command-line
- Now create a Django project here named `courseProjectCbv` using command below

  ```bash
  django-admin startproject courseProjectCbv
  ```

- Then start virtual environment using command below

  ```bash
  env\Scripts\activate
  ```

- Goto Django project directory `djangoprojects/courseProjectCbv` using command below

  ```bash
  cd courseProjectCbv
  ```

- Now create a Django app named `courseApp` using command below

  ```bash
  python manage.py startapp courseApp
  ```

- Now open this project directory `djangoprojects/courseProjectCbv` in your IDE VS Code using command

  ```bash
  code .
  ```

- First open the `settings.py` file in `courseProjectCbv` folder, and search for property `INSTALLED_APPS` and append the name of `courseApp` to add this app

  ```python
  INSTALLED_APPS = [
      'django.contrib.admin',
      'django.contrib.auth',
      'django.contrib.contenttypes',
      'django.contrib.sessions',
      'django.contrib.messages',
      'django.contrib.staticfiles',
      'courseApp',
  ]
  ```

#### Create the Model

- Open `models.py` to create model class in it
- Modify the `models.py` file as per below code

  ```python
  from django.db import models
  # from django.urls import reverse

  # Create your models here.
  class Course(models.Model):

      """Model definition for Course"""
      name = models.CharField(max_length=30)
      description = models.CharField(max_length=50)
      instructor = models.CharField(max_length=30)
      rating = models.FloatField()

      # class Meta:
      #     verbose_name = _("Course")
      #     verbose_name_plural = _("Courses")

      def __str__(self):
          return self.name

      # def get_absolute_url(self):
      #     return reverse("course_detail", kwargs={"pk": self.pk})
  ```

#### Create the Views

- We need to create views to render data to and from between models and templates
  - Open `views.py` file in `courseApp` folder
  - Modify the `views.py` as per below code to add five Class-Based views extending from `ListView`, `DetailView`, `CreateView`, `UpdateView` and `DeleteView`

    ```python
    from django.shortcuts import render
    from django.views.generic import ListView, DetailView, CreateView, UpdateView, DeleteView
    from courseApp.models import Course
    from django.urls import reverse_lazy, reverse

    # Create your views here.
    class CourseListView(ListView):
        """ListView definition for view to list out the courses from Course Model.\
        This view retrieves and displays a list of Course Model objects, using a response rendered \
        by the default template

        Attributes:
            model (Course): The Model associated with this view, representing the Course objects to be listed
            template_name (str): The name of the template to be used for rendering the list. \
                Defaults to 'courseApp/templates/courseApp/course_list.html'
            context_object_name (str): The context variable name for the list of Course Objects. \
                Defaults to 'course_list'
        
        Inherits from:
            ListView: A base class to render some list of objects.
        """
        model = Course
        # template_name = "course_list.html"
        # context_object_name = 'course_list'

    class CourseDetailView(DetailView):
        """DetailView definition for view to display details for Course Model object. \
        This view retrieves and presents the details of a specific Course Model object. \
        The response is rendered using the default template

        Attributes:
            model (Course): The model associated with this view, representing the Course Model \
                object to be displayed
            template_name (str): The name of the template used to render the Detail view. \
                Defaults to 'courseApp/templates/courseApp/course_detail.html'
            context_object_name (str): THe context variable name for the Course object. \
                Defaults to 'course'
        
        Inherits from:
            DetailView (class): A base class view for rendering a "detail" view of a Model Object.
        """
        model = Course
        # template_name = "course_detail.html"
        # context_object_name = 'course'

    class CourseCreateView(CreateView):
        """CreateView definition for view to create a Course Model object.\
        This view handles the creation of a new Course object, with a response rendered \
        by the default template

        Attributes:
            model (Course): The Model associated with this view, representing the Course \
                object to be created
            fields (list): The fields of the course Model to be displayed in the Create Form.
            template_name (str): The name of template to be used for rendering the Create form.\
                Defaults to 'courseApp/templates/courseApp/course_form.html'
            context_object_name (str): The context variable name for the form. \
                Defaults to 'form'
        
        Inherits from:
            CreateView: A base class view for creating a new object, with a response rendered by \
                a template.
        
        Methods:
            get_context_data(self, **kwargs) -> dict: Returns the context data for the template, \
                overriding the base class function to add 'display_view_name' besides the other\
                context data, for displaying the Create operation at title and body.
            get_success_url(self) -> str: Overrides the default behavior of `CreateView` to return a \
                dynamic URL based on the primary key `pk` of the newly created Course instance.
        """
        model = Course
        fields = ('name', 'description', 'instructor', 'rating')
        # template_name = "course_form.html"
        # context_object_name = 'form'
        
        def get_context_data(self, **kwargs) -> dict:
            context = super().get_context_data(**kwargs)
            context["display_view_name"] = 'Create'
            return context
        
        def get_success_url(self):
            return reverse(viewname='course_detail', kwargs={'pk': self.object.pk})

    class CourseUpdateView(UpdateView):
        """UpdateView definition for view to update the Course Details from Course Model object. \
        This view handles the updating of a course object. Upon successful update, it redirects \
        to a specified success URL.

        Attributes:
            model (Course): The model associated with this view, representing the Course \
                object to be updated
            fields (list): The fields of the course Model to be displayed in the Update Form. \
                Defaults to '__all__' literal indicating all of the fields in Model.
            template_name (str): The name of the template to be used for rendering the Update form. \
                Defaults to 'courseApp/templates/courseApp/course_form.html'
            context_object_name (str): The context variable name for the form. \
                Defaults to 'form'.
        
        Inherits from:
            UpdateView: A base class view for updating an object, with a response rendered by \
                a template
        
        Methods:
            get_context_data(self, **kwargs) -> dict: Returns the context data for the template, \
                overriding the base class function to add 'display_view_name' besides the other \
                context data, for displaying the Update operation at title and body.
            get_success_url(self) -> str: Overrides the default behavior of `UpdateView` to return a \
                dynamic URL based on the primary key `pk` of the updated Course instance.
        """
        model = Course
        fields = '__all__'
        # template_name = "course_form.html"
        # context_object_name = 'form'
        
        def get_context_data(self, **kwargs) -> dict:
            context = super().get_context_data(**kwargs)
            context["display_view_name"] = 'Update'
            return context
        
        def get_success_url(self):
            return reverse(viewname='course_detail', kwargs={'pk': self.object.pk})

    class CourseDeleteView(DeleteView):
        """DeleteView definition for view to delete from Course Model. \
        This view handles the deletion of the Course object. Upon successful deletion, \
        it redirects to a specified success URL.

        Attributes:
            model (Course): The model associated with this view, representing the Course \
                object to be deleted
            success_url (str): The URL to redirect to after successful deletion. Recommended to \
                use `reverse_lazy(viewname)` to ensure proper URL resolution.
            template_name (str): The name of the template to be used to confirm deletion. \
                Defaults to 'courseApp/templates/courseApp/course_confirm_delete.html'
            context_object_name (str): The context variable name for the Model object to be deleted. \
                Defaults to 'course'
        
        Inherits from:
            DeleteView: A base class view for deleting a Course Model object, with a response \
                rendered by a template
        """
        model = Course
        success_url = reverse_lazy(viewname='course_list')
        # template_name = "course_confirm_delete.html"
        # context_object_name = 'course'
    ```

#### Create the Templates

- Before creating templates, we need to configure the templates
  - In your IDE, Create a folder `templates/courseApp` inside the project folder `courseProjectCbv`
  - Now add this path, open `settings.py` file, search for `TEMPLATES` property, and in `DIRS` append as below, we'll add `BASE_DIR` as `templates` only, rest of the path, we've specified in respective views

    ```python
    TEMPLATES = [
        {
            'BACKEND': 'django.template.backends.django.DjangoTemplates',
            'DIRS': [BASE_DIR / 'templates'],
            'APP_DIRS': True,
            'OPTIONS': {
                'context_processors': [
                    'django.template.context_processors.debug',
                    'django.template.context_processors.request',
                    'django.contrib.auth.context_processors.auth',
                    'django.contrib.messages.context_processors.messages',
                ],
            },
        },
    ]
    ```

- Now we need to create four template files in `courseApp/templates/courseApp` folder, and then modify as per code shown below
  1. `course_list.html`
      - Modify it as below

      ```python
      <!DOCTYPE html>
      <html lang="en" dir="ltr">
          <head>
              <meta charset="utf-8">
              <title>Course List</title>
          </head>
          <body>
              <h1>Courses List</h1>
              {% if course_list %}
              <table border=2>
                  <thead>
                      <th>Id</th>
                      <th>Course Name</th>
                      <th>Instructor</th>
                  </thead>
                  {% for course in course_list %}
                  <tr>
                      <td><a href="/{{ course.id }}">{{ course.id }}</a></td>
                      <td>{{ course.name }}</td>
                      <td>{{ course.instructor }}</td>
                  </tr>
                  {% endfor %}
              </table>
              {% else %}
              <p>No Courses Found</p>
              {% endif %}
              <br/><br/><br/>
              <a href="/create">Add Course</a>
          </body>
      </html>
      ```

  2. `course_detail.html`
      - Modify it as below

      ```python
      <!DOCTYPE html>
      <html lang="en" dir="ltr">
          <head>
              <meta charset="utf-8">
              <title>Course Details</title>
          </head>
          <body>
              <h1>Course Details</h1>
              <ol>
                  <h3><li>Course ID: {{ course.id }}</li></h3>
                  <h3><li>Course Name: {{ course.name }}</li></h3>
                  <h3><li>Course Description: {{ course.description }}</li></h3>
                  <h3><li>Course Instructor: {{ course.instructor }}</li></h3>
                  <h3><li>Course Rating: {{ course.rating }}</li></h3>
                  <h3><li><a href="/update/{{ course.id }}">Update</a></li></h3>
                  <h3><li><a href="/delete/{{ course.id }}">Delete</a></li></h3>
              </ol>
              <br/><br/><br/>
              <a href="/courses">Go back to Course List</a>
          </body>
      </html>
      ```

  3. `course_form.html`
      - Modify it as below

      ```python
      <!DOCTYPE html>
      <html lang="en" dir="ltr">
          <head>
              <meta charset="utf-8">
              <title>{{ display_view_name }} Course</title>
          </head>
          {% comment %} title and h1 tag is dynamic depending on view_name {% endcomment %}
          <body>
              <h1>{{ display_view_name }} Course</h1>
              <form method="post">
                  {{ form.as_p }}
                  {% csrf_token %}
                  <input type="submit" value="Save">
                  {% if display_view_name == "Create" %}
                      <a href="/courses">Go back to Course List</a>
                  {% else %}
                      <a href="/{{ course.id }}">Cancel Update</a>
                  {% endif %}
              </form>
          </body>
      </html>
      ```

  4. `course_confirm_delete.html`
      - Modify it as below

      ```python
      <!DOCTYPE html>
      <html lang="en" dir="ltr">
          <head>
              <meta charset="utf-8">
              <title>Delete Course</title>
          </head>
          <body>
              <h1>Are you sure to delete course {{ course.name }} ?</h1>
              <form method="post">
                  <input type="submit" value="Confirm">
                  <a href="/{{ course.id }}">Cancel</a>
                  {% csrf_token %}
              </form>
          </body>
      </html>
      ```

#### Configure the URLs

- To configure the URLs, open `urls.py` file and add path to the five views you've created as per below code

  ```python
  from django.contrib import admin
  from django.urls import path
  from courseApp import views

  urlpatterns = [
      path('admin/', admin.site.urls),
      path(route='courses/', view=views.CourseListView.as_view(), name='course_list'),
      path(route='<int:pk>/', view=views.CourseDetailView.as_view(), name='course_detail'),
      path(route='create/', view=views.CourseCreateView.as_view()),
      path(route='update/<int:pk>/', view=views.CourseUpdateView.as_view()),
      path(route='delete/<int:pk>/', view=views.CourseDeleteView.as_view()),
  ]
  ```

#### Do the migrations

- Before doing migrations, we need to configure the database connection
  - Open MySQL Workbench and create a database `coursesdbcbv` using command below

    ```sql
    CREATE DATABASE coursesdbcbv;
    ```

  - Once database is created, now open `settings.py` in IDE, we need to configure `DATABASES` property, search for it and make changes as per below snippet

    ```python
    DATABASES = {
        'default': {
            'ENGINE': 'django.db.backends.mysql',
            'NAME': 'coursesdbcbv',
            'USER': 'root',
            'PASSWORD': 'mysql',
        }
    }
    ```
  
  - Now to test this database connection, goto the command-line/terminal, make sure you're at the project directory `djangoprojects/courseProjectCbv`, then launch python interactive shell using command

    ```bash
    python manage.py shell
    ```

  - Run below command in python interactive shell, if it doesn't give any error message, it means our connection is good to go

    ```bash
    from django.db import connection
    c = connection.cursor()
    ```

  - Once database connection is configured, you may exit the python interactive shell using `Ctrl+D`, and now we can run migrations
  - To make migrations run the command below, it should generate a `courseApp\migrations\0001_initial.py` file

    ```bash
    python manage.py makemigrations
    ```

  - Now do migration using command, it'll apply all the migrations to create the tables for the app courseApp

    ```bash
    python manage.py migrate
    ```

  - To check if the tables have been created, goto MySQL Workbench and run command below to list all tables, it should list a app table courseapp_course

    ```sql
    USE coursesdbcbv;
    SHOW TABLES;
    ```

  - To list the contents of `courseapp_course` table, use command below

    ```sql
    SELECT * FROM courseapp_course;
    ```

#### Test the Application

- To test the application, you need to run the Django server
- Goto the command-line/terminal, make sure you're in the project directory `djangoprojects/courseProjectCbv`, and run the command below to run Django server

  ```bash
  python manage.py runserver
  ```

- Now goto web-browser and visit URL at `localhost:8000/courses` to visit the page rendered by the `CourseListView` which should show a message `No Courses Found` as there are no records in the database currently, and a link `Add Course`
  - To Add/Create course, click on `Add Course` link, it'll open a create form rendered by `CourseCreateView`, fill details and click on `Save` button, it'll redirect you to details page rendered using `CourseDetailView` after successful creation
  - Now on this Course Details page, you may update it by clicking on `Update` button, it'll load a form to update rendered by `CourseUpdateView`, change the values and click on `Save`, it'll then take you to Course details page
  - To Perform deletion operation, first click on `Go back to Course List` link on Course Details page, and it'll open the Course List Page, click on the `id` of the course to open the course details page, there click on `Delete` link to delete it, a delete confirmation page will open rendered by `CourseDeleteView`, click on `Confirm` button, and it'll redirect to Course List page upon successful deletion
