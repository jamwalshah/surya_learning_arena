# Message Queue | System Design

> Message Queue is a form of service-to-service communication that facilitates asynchronous communication. It asynchronously receives messages from producers and sends them to consumers

## What is Message Queue?

> A message queue is a component of messaging *[middleware](https://www.ibm.com/topics/middleware)* solutions that enable independent applications and services to exchange information.

- It is a form of
  - communication and data transfer mechanism used in computer science and system design
  - asynchronous service-to-service communication used in serverless and microservices architectures
- Messages are stored on the queue until they're  processed and deleted
- Each message is processed only once, by a single consumer
- These can be used to decouple heavyweight processing, to buffer or batch work, and to smooth spiky workloads
- It functions as a temporary storage and routing system for messages exchanged between different components, applications, or systems within a larger software architecture
- e.g.
  - Think about your favorite pizza place, where they make  and deliver pizzas.
  - Behind the scenes, there's  a magical system that ensures everything runs smoothly.
  - This magic is called Message Queue. It's like special to-do list that helps chef and delivery drivers know exactly what pizzas to make and where to deliver them, especially when things get super busy
- Message queues are systems that let you have fault-tolerant, distributed, decoupled, service oriented, etc. architecture
- Message queues store "messages" or packets that applications create for other applications
- These messages are created to be used in the order they were transmitted until the consuming application can process them
- It enables messages to wait safely with until the receiving application is ready
- if there is a problem with the network or receiving application, the messages in the message queue are not lost
- This *Asynchronous Messaging* model prevents data loss and enables systems to continue to function if processes or connections fail
- it allows developers to keep processes and applications separate, keeping their their communications self-contained and event-driven to make the architecture more reliable
- these are available in messaging solutions across numerous deployment operations which include
  - optimized physical applications
  - cloud services
  - [mainframes](https://www.ibm.com/topics/mainframe)
  - as software

## Message Queue Basics

- In modern cloud architecture, applications are decoupled into smaller, independent building blocks that are easier to develop, deploy and maintain
- Message Queues provide communication and coordination for these distributed applications
- Message Queues can significantly simplify coding of decoupled applications, while improving performance, reliability and scalability
- These allow different parts of a system to communicate and process asynchronously
- It provides a light-weight buffer  which temporarily stores messages, and endpoints that allow software components to connect to the queue in order to send and receive messages
- The messages are usually small, and can be things like requests, replies, error messages, or just plain information
- The Message is stored on the queue until another component called a consumer retrieves the message and does something with it

<img src="./../../content/sqs_seo_queue.1dc710b63346bef869ee34b8a9a76abc014fbfc9.png"
  alt="message queue (https://d1.awsstatic.com/product-marketing/Messaging/sqs_seo_queue.1dc710b63346bef869ee34b8a9a76abc014fbfc9.png)"
  style="float: centre; margin-right: 10px;"
  />

- Many producers and consumers can use the queue, but each message is processed only once, by a single consumer
- For this reason, this messaging pattern is often called one-to-one, or point-to-point, communications
- When a message is processed  by more than one consumer, message queues can be combined with Pub/Sub messaging in a fanout design pattern
- See "[What is Pub/Sub messaging?](https://aws.amazon.com/what-is/pub-sub-messaging/)" for details, and visit [Amazon Simple Notification Service (SNS)](https://aws.amazon.com/what-is/pub-sub-messaging/) website for an overview of Pub/Sub messaging on AWS

## Why Messaging Queuing ?

- Sometimes we need to do asynchronous processing such as
  - to send SMS, email
  - process orders
  - pass information between services
- This type of background processing is simply not a task that traditional RDBMS is best suited to solve, so we use message queuing which present a fundamentally sound strategy for handling high-volume asynchronous processing

## Example

- Let's say you're running a marketplace e-commerce
- You want to send a set of emails to your customers, sellers, logistic partner and your employees for every order processing
- Your order processing service is dependent on email service and call `sendEmail(...)` before processing
- Your processing is waiting till `sendEmail`gets executed
- What about if your traffic spikes, your `sendEmail(...)` has backlog now
- Here comes Message Queues (MQs), now use some method say `sendEmailsToMq(...)` and send every emails to MQs where it is queued and get processed asynchronously with a separate email handling system
-You have decoupled your messaging system from order process and at the same time you're ensuring there is no loss of data

## Key Components of a Message Queue System

  1. **Message Producer**
      - The message producer is responsible for creating and sending messages to the message queue
      - This can be any application or component within  a system that generates data to be shared
  2. **Message Queue**
      - The Message Queue is a data structure or service that stores and manages the messages until they are consumed by the message consumers
      - It acts as a buffer or intermediary between producers and consumers
  3. **Message Consumer**
      - The message consumer is responsible for retrieving and processing messages from the message queue
      - Multiple Consumers can read messages concurrently from the queue
  4. **Message Broker (Optional)**
      - In some message queue systems, a message broker acts as an intermediary between producers and consumers, providing additional functionality like message routing, filtering and message transformation

## How Message Queues work

  1. **Sending Messages**
      - The message producer creates a message and sends it to the message queue
      - The message typically contains data or instructions that need to be processed or communicated
  2. **Queueing Messages**
      - The message queues stores the messages temporarily, making available for one or more consumers
      - Messages are typically stored in a first-in, first-out (FIFO) order
  3. **Consuming Messages**
      - Message consumers retrieve messages from the queue when they are ready to process them
      - They can do this at their own pace, which enables asynchronous communication
  4. **Acknowledgement (Optional)**
      - In some messages queue systems, consumers can send acknowledge back to the queue, indicating that they have successfully processed a message
      - This is essential for ensuring message delivery and preventing message loss

## Need to Message Queue

- Message Queue are needed to address a number of challenges in distributed systems, including
    1. **Asynchronous Communication**
        - Message queue allow applications to send and receive messages without having to wait for a response
        - This is essential for building scalable and reliable systems
    2. **Decoupling**
        - Message queue decouple application from each other, allowing them to be developed independently
        - This makes systems more flexible and easier to maintain
    3. **Scalability**
        - Message queues can be scaled to handle large volumes of messages by adding more servers
        - This makes them ideal for high-traffic applications
    4. **Reliability**
        - Message Queues can be designed to be highly reliable, with features such as message persistence, retries, dead letter queues
        - This ensures that messages are not lost even in the event of failures
    5. **Workflow Management**
        - Message queues can be used to implement complex workflows, such as order, processing and payment processing
        - This can help improve the efficiency and accuracy of these processes

## Where to use Message Queue

There are several real-life use cases of Message Queues

1. **Decoupling**
    - A decoupled architecture is where the different components/layers that make up the system interact with each other using well-defined interfaces rather than depending tightly on each other
    - With such an architecture , the components/layers can be developed independently without having to wait for their dependencies to complete
    - This leads to *pipelined* development, resulting in more streamlined and faster development
    - This also improves the testability of the components
    - By using a queue between different component you can decouple the dependencies
    - The format of the message in the queue becomes your data contract and anything that knows how to read that message format can be used to process the transaction
    - This could be useful for parts of your code that are even written in different programming languages

2. **Scalability**
    - Since message queues decouple your system/component, it becomes easy to scale up every individual component without worrying about any code change or configuration change
3. **Persistence**
    - Every system/application has some issues, it crashes, bugs, errors, etc. are part of this.
    - If your data is not persisted, it is gone forever. Message Queues provide this data persistence.
    - Queues mitigate this by persisting data until it has been fully processed
    - The put-get-delete paradigm, which many message queues use , requires a process to explicitly indicate that it has finished processing a message before the message is removed from the queue, ensuring the data is kept safe until you're done with it
4. **Traffic Spikes**
    - You don't always know exactly how much traffic your application is going to have
    - By queueing the data, we can be assured that the data will be persisted  and then processed eventually, even if that means it takes a little longer than usual due to a high traffic spike
5. **Monitoring**
    - Message Queuing systems enable you to monitor how many items are in a queue, the rate of processing messages, and other stats
    - This can be very helpful from an application monitoring standpoint to keep an eye on how data is flowing through your system and if it is getting backed up
6. **Asynchronous Communication**
    - A lot of times you don't want to or need to process a message immediately
    - Message Queues enable asynchronous processing, which allows your to put a message on the queue without processing immediately
    - Queue up as many messages as you like, then process them at your leisure
7. **Batch Process**
    - Message Queues are very useful when we want to do batching
    - e.g. It is much more efficient to insert 1000 records into a database at a time instead of 1 at a time, 1000 times. We insert a lot of data into elasticsearch and SQL  Server. Batching helps us optimize their performance by tuning  the size of the transactions
8. **Ordering**
    - Message Queues are inherently ordered, and capable of providing guarantees that data will be processed  in a specific order (FIFO)
9. **Delivery**
    - No matter how many processes are pulling data from  the queue, each message will only be processed  a single time
10. **Data Flow**
    - In a distributed system, getting  an overall sense of how long user actions take to complete and why is it a huge problem
    - Message Queues, through the rate with which they are processed, help to easily identify under-performing processes or areas where the data flow is not optimal

## Features of Message Queuing

- Using a message queue, we can efficiently support a significantly higher volume of concurrent messages
- messages are pushed in real-time instead of periodically polled
- messages are automatically cleaned up after being received and we don't need to worry about any deadlocks or race conditions

## Benefits of Message Queuing

- **Reliable Message Delivery:**
  - Using a message queue ensures that business-critical  messages between applications will not be lost and that they will only be delivered to the recipient once
  - with this feature in place, additional de-duplication or loss-prevention logic is unnecessary
- **Inter-Application Connectivity**
  - Some message queue solutions can handle message encryption, transactionality and other communication aspects between applications and services
  - It simplifies application development
  - It enables disparate architectures to work together
- **Versatility**
  - Message Queue solutions can support multiple languages , such as [Java](https://www.ibm.com/topics/java), Node.js, COBOL, C/C++, Go, .NET, Python, Ruby and C#
  - These can also support numerous Application Programming Interfaces (APIs) and protocols including MQTT(Message Queuing Telemetry Transport), AMQP(Advanced Message Queuing Protocol), [REST](https://www.ibm.com/topics/rest-apis)(REpresentational State Transfer) and many more
- **Resilience**
  - Asynchronous messaging ensures application-specific faults won't impact the system
  - If one component in the system stalls, all others can continue interacting with the queue and processing messages
  - This decreases the chances that the entire system's stability will be impacted by one part's failure
- **Improved Security**
  - A message queue may be able to identify and authenticate all messages
  - In some message queue solutions, they can be set to encrypt messages at rest, in transit or end-to-end
  - This can contribute to the overall security of the applications and infrastructure
- **Integrated file transfers**
  - Some [message queue solutions](https://www.ibm.com/products/mq/advanced) include additional features, such as the ability to transfer files
  - This can be used as an alternative to FTP within enterprise where such solutions are in use

## Use cases

- Message Queues are used in a wide variety of applications, including
  - **Ecommerce**
    - Message Queues are used to process orders, payments and shipping notifications
  - **Financial Service**
    - Message Queue are used to process transactions, fraud detection, and risk management systems
  - **Gaming**
    - Message queue used to synchronize game servers and clients
  - **Social Media**
    - Message queues are used to distribute message and notification to users
  - **Internet of Things (IoT)**
    - Message Queue are used to collect and process data from IoT devices
- Today's enterprise computing environments are complex and highly decentralized
- Messaging makes it easier to integrate applications and services on diverse platforms by providing a single, robust and secure shared messaging backbone
- This protects against data loss and ensures that systems continue to function even with unstable connectivity
</br></br>
- Message queues are uniquely suited for integrating on-premises backend systems with cloud services
- In cloud architectures, applications are often broken down into small, independent components
- This makes it easier to design and code them, and also easier to manage their performance
- Message queues enable these decoupled cloud-based applications to communicate with each other or with on-premise systems
</br></br>
- Message queuing increases architecture resilience because the messages can have persistence
- This means they're stored to disk until the service receiving the message confirms processing
- Message queues can be used in scenarios requiring high levels of security, fault tolerance and accuracy, such as
  - financial transaction processing
  - air-travel booking
  - updating healthcare patient records
- Message queues can also be used to enable applications and systems residing different clouds (whether [public cloud](https://www.ibm.com/topics/mobile-cloud-computing) or [private cloud](https://www.ibm.com/topics/private-cloud)) to communicate, even if they are located in different countries or even on remote continents
- Using a message queue increases fault tolerance and can be used to prevent data being duplicated or lost across geographically and technically disparate systems
- Because each service within the system is decoupled, or logically separated from the others, each can continue to function if other services or applications fail or stall
</br></br>
- Message queues work across disparate applications such as [mobile](https://www.ibm.com/topics/mobile-cloud-computing), IoT and traditional system records
- They also support various platforms, such as [virtual machines](https://www.ibm.com/topics/virtual-machines) and [containers](https://www.ibm.com/topics/containers), and can enable integration between legacy applications and today's latest solutions

## Message Queue Vs. other messaging models

### Message Queue vs. Publish/Subscribe

- Message queues use a point-to-point messaging pattern, in which one application (called the sender) submits a message to the queue and another application (called the receiver) gets the message from the queue and uses it
- There should be a tightly coupled on-to-one relationship between the sender and consumer, and each message should be consumed only once</br></br>
- If your application requires to be distributed to multiple parties, either
  - multiple message queues can be combined, or
  - a publish /subscribe (pub/sub) messaging model can be used</br></br>
- In pub/sub messaging, the application that produces the message is called the **publisher**, and the applications that are using it are called **subscribers**
- Each message is published to a topic, and every application that subscribes to that topic gets a copy of all messages that are published to it</br></br>
- Most messaging middleware solutions support both the message queue (point-to-point) and pub/sub messaging models

### Message queue vs. Message Bus

- A Message Bus, which is a type of [enterprise bus service](https://www.ibm.com/topics/esb) (ESB), allows services ubiquitous access to data while ensuring that they remain decoupled and independently functional within a distributed system architecture
- When you employ a message bus, all the services or applications must share common data types, a common command set and common communication protocols (although they may be written in different languages)
- Consumers can determine how they use the messages</br></br>
- If decoupled applications are to communicate through a message bus, the messages must be transformed so that they are all the same type
- In contrast, message queues transport messages, whether they are of the same or different types

### Message Queue vs. Web Services

- Applications can communicate directly through [web services](https://www.ibm.com/docs/en/cics-ts/6.1) of APIs based on standard protocols, such as Simple Object Access Protocol (SOAP) or HTTP, instead of through messaging middleware
- Web Services are widely used in distributed systems, which are relatively simple and easy to implement, making them a variable alternative to message queues in certain use cases and scenarios</br></br>
- However, unlike message queues, web services cannot guarantee message delivery
- If the server connection fails, you must build the capability to handle the error within the client
- Web Services also lack pub/sub distribution models
- Messaging middleware offers greater fault tolerance and better ability to handle heavy traffic or activity bursts</br></br>
- To learn more about when to use APIs, when to use messaging or when to use both , see "[An introduction to APIs and messaging](https://developer.ibm.com/articles/introduction-apis-and-messaging)."

### Message Queue vs. Databases

- Databases can be used as an alternative to message queues in certain situations
- However, they serve different purposes and are not readily interchangeable most of the time
- Databases are most commonly used for storage, and they allow you to access the same  information over and over again
- Message queues cannot be used for storage purposes
- Once a message has been consumed, it is deleted from the queue</br></br>
- Designing message queue-like functionality into a database is possible, but it requires a great deal of coding effort and knowledge
- Databases can only be used to replicate simple queue structures and aren't scalable for larger applications

- Check out "[A Brief Overview of the Database Landscape](https://www.ibm.com/blog/brief-overview-database-landscape/)" for more info on databases and their capabilities

## Message-Queuing-As-A-Service

- Message Queuing is traditionally administered by dedicated teams within IT
- But "as-a-service" delivery, using a [cloud-hosted](https://www.ibm.com/topics/cloud-hosting) message queue can enable individuals or line-of-business (LoB) users to request changes to the messaging infrastructure on their own, through a portal, which can increase agility </br></br>
- Message-Queuing-As-A-Service naturally works well within [serverless](https://www.ibm.com/topics/serverless) or [microservices](https://www.ibm.com/topics/microservices) architectures common in [cloud-native](https://www.ibm.com/topics/cloud-native) development
- Because it's offered in a cloud-hosted service model, the cloud provider handles all the provisioning, installation and maintenance of your messaging infrastructure, and it is hosted in the cloud

## Pub/Sub Messaging

### What is Pub/Sub Messaging?

- Publish/Subscribe messaging, or pub/sub messaging, is an asynchronous communication model that makes it easy for developers to build highly functional and architecturally complex applications in the cloud
- In modern cloud architecture, applications are  decoupled into smaller, independent building blocks called *services*
- Pub/Sub messaging provides instant event notifications for these distributed systems
- It supports scalable and reliable communication between independent software modules

### How does pub/sub messaging work?

- The publish-subscribe (sub/sub) system has four key components

  1. **Messages**
      - A message is communication data sent from sender to receiver
      - Message data types can be anything from strings to complex objects representing text, video, sensor data, audio, or other digital content
  2. **Topics**
      - Every message has a topic associated with it
      - The topic acts like an intermediary channel between senders and receivers
      - It maintains a list of receivers who are interested in messages about that topic
  3. **Subscribers**
      - A subscriber is the message recipient
      - Subscribers have to register (or subscribe) to topics of interest
      - They can perform different functions or do something different with the message in parallel
  4. **Publishers**
      - The publisher is the component that sends messages
      - It creates messages about a topic and sends them once only to all subscribers of that topic
      - This interaction between the publisher and subscribers is a one-to-many relationship
      - The publisher doesn't need to know who is using the information it is broadcasting, and the subscribers don't need  to know where the message comes from

<img src="./../../content/sns_img_topic.e024462ec88e79ed63d690a2eed6e050e33fb36f.png"
  alt="(https://d1.awsstatic.com/product-marketing/Messaging/sns_img_topic.e024462ec88e79ed63d690a2eed6e050e33fb36f.png)"
  style="float: centre; margin-right: 10px;"
  />

### What are the features  of a  pub/sub messaging system?

- Applications developed with a publish-subscribe (pub/sub) pattern have separate application and communication logic
- The messaging infrastructure decouples messages delivery between publishers and subscribers and broadcasts to different subscribers asynchronously
- The pub/sub communication system has the following key features

  1. **Push Delivery**
      - Pub/Sub messaging instantly pushes asynchronously event notifications when messages are published to the message topic
      - Subscribers are notified when a message is available
  2. **Multiple Delivery Protocols**
      - Topics connect to multiple types of endpoints, such as message queues, serverless functions, HTTP servers, and email addresses
  3. **Fanout**
      - This scenario happens when a message is sent to a topic and then replicated and published to multiple endpoints
      - Fanout provides asynchronous asynchronous event notifications, which in turn allow for parallel processing
  4. **Filtering**
      - The filtering feature empowers the subscriber to create a message filtering policy
      - So, they'll get only the notifications they're interested in, as opposed to receiving every single message posted to the topic
  5. **Multiplexing**
      - In some cases, publishers can also be subscribers
      - You can multiplex message streams and create  systems that link  together in an internally consistent manner

### What are the benefits of pub/sub messaging?

- The publish-subscribe (pub/sub) model enables [event-driven architecture](https://aws.amazon.com/event-driven-architecture/) which is required in several modern applications
- You can use events to trigger and communicate between decoupled services
- An event is a change in state, or an update, like an item being placed in a shopping cart
- Pub/Sub messaging provides significant advantages to developers who build applications that rely on real-time events
- Following are some of its advantages
  1. **Eliminate Polling**
      - Message Topics allow instantaneous, push-based delivery, eliminating the need for message consumers to periodically check, or poll, for new information and updates
      - This promotes faster response time and reduces the delivery latency that can be particularly problematic in systems where delays cannot be tolerated
  2. **Dynamic Targeting**
      - The pub/sub pattern makes the discovery of services easier, more natural, and less error-prone
      - Instead of maintaining a roster of peers so an application can send messages, a publisher will simply post messages to a topic
      - Then, any interested party will subscribe its endpoint to the topic and start receiving these messages
      - Multiple subscribers can change, upgrade, or disappear, and the system adjusts dynamically
  3. **Decouple and scale independently**
      - Pub/Sub makes the software more flexible
      - Publishers and subscribers are decoupled and work independently from each other, which allows you to develop and scale them independently
      - You can decide to handle orders one way this month and then another the following month
      - Adding or changing functionality won't send ripple effects across the sytem, because pub/sub allows you to flex how everything works together
  4. **Simplify Communication**
      - Code for communications and integration is some of the hardest to write
      - The publish-subscribe model reduces complexity by removing all the point-to-point connections with a single connection to a message topic
      - The topics will manage subscriptions to decide what messages should be delivered to which endpoint
      - Fewer callbacks result in looser coupling, plus  code that is easier to maintain and extend
  5. **Durability**
      - Pub/Sub messaging services often provide very high durability, and at-least-once delivery, by storing copies of the same message on multiple servers
  6. **Security**
      - Message topics authenticate applications that try to publish content and allow you to use encrypted endpoints to secure messages in transit over the network

### What are the use cases of pub/sub messaging?

- The popular use cases of the publish-subscribe (pub/sub) messaging system are

    1. **Perfrom Parallel Asynchronous Processing**
        - Events published to a message topic can trigger multiple workers to perform necessary but unrelated task simultaneously
    2. **Deliver application and system alerts**
        - Instantly deliver critical updates and asynchronous event notifications to affected application components and your users
    3. **Manage Asynchronous Workflows**
        - Relay events among applications, or break up a larger task into many smaller ones and use message queuing to divide the work among multiple workers
    4. **Balance Workoads**
        - Batch up tasks for bulk processing, or break up a larger task into many smaller ones and use message queuing to divide the work among multiple workers
    5. **Log to multiple systems**
        - Record events to analyze later, capture logs for operations and security, or to archive to meet backup or compliance requirements
    6. **Use Fanout for replication**
        - Replicate data between production and development environments, or develop and test with live data
    7. **Coordinate serverless applications**
        - Fanout asynchronous event notifications to distributed functions and message queues to coordinate the components of your serverless applications
    8. **Stream IoT Data**
        - The Pub/Sub pattern is a very powerful way for Internet of Things (IoT) devices to interact
        - Devices can easily stream data to backend systems or each other

### What is the difference between Message Queues and pub/sub messaging?

- A [message queue](https://aws.amazon.com/message-queue/) is another form of asynchronous communication used in [serverless](https://aws.amazon.com/serverless/) and [microservices](https://aws.amazon.com/microservices/) architectures
- Messages are stored in the queue until they are processed and deleted
- Messages require the sender to know who they're exchanging the messages with
- Message ordering may also cause bottleneck in the system
</br></br>
- On contrast, the publish-subscribe (pub/sub) pattern allows for more flexibility
- Several interested subscribers can receive messages simultaneously and asynchronously
- Publishers don't need to know who the subscribers are
- Message handling is more scalable and reliable, and it gives better performance

### How can AWS support your pub/sub messaging requirements?

- Amazon Web Services (AWS) has two services you can use for different publish-subscribe (pub/sub ) applications

  1. **Pub/Sub APIs**
      - [AWS AppSync](https://aws.amazon.com/appsync/) is a fully managed service for creating GraphQL  and pub/sub APIs that simplify application development
      - You can create a single endpoint to securely query, update, or publish data
      </br></br>
      - Pub/Sub APIs built with AWS AppSync give you the ability to publish real-time data updates to subscribed API clients through serverless WebSocket connections
      - You can create engaging real-time experiences for a variety of use cases
      - For example, you can deliver up-to-date scores, financial data, audience participation, voting, location-awareness functionality such as maps and push notification marketing
      </br></br>
      - Here are some things that you can accomplish with AWS AppSync
          - Access data from one or more sources or microservices with a single network request
          - Interact with and update data-even offline-with offline data synchronization, versioning, and conflict resolution
          - Pay only for requests to you API and any real-time messages delivered to connected clients
  2. **Pub/Sub Messaging***
      - [Amazon Simple Notification Service (SNS)](https://aws.amazon.com/sns/) makes it easier for you to build an application using the pub/sub messaging model
      - You can send messages from your applications to customers or other applications in a scalable  and cost-effective manner
      </br></br>
      - Amazon SNS offers several features
          - High-throughput, push-based, many-to-many messaging between distributed systems, microservices, and event-driven serverless applications
          - Message encryption and traffic privacy
          - Fanout capabilities across AWS categories such as analytics, compute, containers, databases, Internet of Things (IoT), Machine Learning (ML), security, and storage
